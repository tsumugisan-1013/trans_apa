<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>APA形式 著者変換ツール（完全版）</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 40px auto;
      max-width: 800px;
      padding: 20px;
    }
    textarea {
      width: 100%;
      height: 120px;
      margin-bottom: 10px;
    }
    button {
      margin-right: 10px;
      padding: 6px 12px;
    }
    #apaOutput {
      margin-top: 20px;
      padding: 10px;
      background: #f4f4f4;
      border: 1px solid #ccc;
      min-height: 50px;
    }
    #historyList div {
      margin-top: 10px;
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
<h2>APA形式 著者変換ツール（完全版）</h2>
<p>APA形式の文献著者情報を、正しく整形・整列して出力します。</p>

<textarea id="inputText" placeholder="ここにAPA形式または近い形で著者情報を含む文献情報を貼り付けてください"></textarea>
<button onclick="reconstructAPA()">APA形式に変換</button>
<button onclick="copyAPA()">コピー</button>
<button onclick="clearInput()">クリア</button>

<div id="apaOutput"></div>

<h3>変換履歴</h3>
<div id="historyList"></div>

<script>
function reconstructAPA() {
  let input = document.getElementById("inputText").value.trim();
  const output = document.getElementById("apaOutput");
  output.textContent = "";

  const yearMatch = input.match(/\(\d{4}\)/);
  if (!yearMatch) {
    output.textContent = "年情報が見つかりませんでした。";
    return;
  }

  const yearIndex = input.indexOf(yearMatch[0]);
  let beforeYear = input.substring(0, yearIndex).trim();
  let afterYear = input.substring(yearIndex).trim();

  beforeYear = beforeYear
    .replace(/,?\s+and\s+/gi, ", ")
    .replace(/,?\s*&\s*/gi, ", ")
    .replace(/\s{2,}/g, " ")
    .trim();

  const parts = beforeYear.split(",").map(p => p.trim()).filter(p => p !== "");
  const authors = [];

  for (let i = 0; i < parts.length - 1; i++) {
    const current = parts[i];
    const next = parts[i + 1];

    if (/^([A-Z]\.?\s?)+([A-Z])?$/.test(next)) {
      if (authors.length === 0) {
        authors.push(`${current}, ${next}`.trim());
      } else {
        authors.push(`${next} ${current}`.trim());
      }
      i++;
    }
  }

  let authorStr = "";
  if (authors.length === 1) {
    authorStr = authors[0];
  } else if (authors.length === 2) {
    authorStr = `${authors[0]} and ${authors[1]}`;
  } else {
    const last = authors.pop();
    authorStr = `${authors.join(", ")} and ${last}`;
  }

  let fullAPA = `${authorStr} ${afterYear}`;

  fullAPA = fullAPA
    .replace(/\)\./g, ")")
    .replace(/([A-Za-z])\.\s*([^0-9]+),\s*(\d+)/, "$1. $2 $3")
    .replace(/(\d+),\s*(\d+([-–]\d+)?)/, "$1: $2")
    .replace(/(\d+)\(\d+\),\s*(\d+([-–]\d+)?)/, "$1: $2");

  output.textContent = fullAPA;
  saveToHistory(fullAPA);
  clearInput();
}

function copyAPA() {
  const text = document.getElementById("apaOutput").textContent;
  if (!text) return;
  navigator.clipboard.writeText(text).then(() => alert("コピーしました！"));
}

function clearInput() {
  document.getElementById("inputText").value = "";
}

function saveToHistory(entry) {
  let history = JSON.parse(localStorage.getItem("apaHistory") || "[]");
  history.unshift(entry);
  if (history.length > 20) history = history.slice(0, 20);
  localStorage.setItem("apaHistory", JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  const container = document.getElementById("historyList");
  container.innerHTML = "";
  let history = JSON.parse(localStorage.getItem("apaHistory") || "[]");
  history.forEach((entry, index) => {
    const div = document.createElement("div");
    div.textContent = entry;
    const btn = document.createElement("button");
    btn.textContent = "コピー";
    btn.onclick = () => navigator.clipboard.writeText(entry);
    div.appendChild(btn);
    container.appendChild(div);
  });
}

renderHistory();
</script>
</body>
</html>
